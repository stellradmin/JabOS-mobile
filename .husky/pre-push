#!/usr/bin/env sh
# =================================================================
# STELLR PRE-PUSH HOOK
# =================================================================
# Runs comprehensive checks before pushing to remote
# More thorough than pre-commit - includes full test suite

. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running Stellr pre-push validation..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}$message${NC}"
}

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

print_status $BLUE "ğŸ” Step 1: Full repository secret scan..."

# Full repository secret scan
if command_exists gitleaks; then
    if ! gitleaks detect -v -s . -c .gitleaks.toml --redact --no-banner; then
        print_status $RED "âŒ PUSH BLOCKED: Secrets detected in repository!"
        print_status $RED "   Repository contains sensitive data that must be removed"
        exit 1
    else
        print_status $GREEN "âœ… Repository secret scan passed"
    fi
fi

print_status $BLUE "ğŸ§ª Step 2: Full test suite..."

# Run full test suite
if npm run test:production-ready > /dev/null 2>&1; then
    print_status $GREEN "âœ… Full test suite passed"
else
    print_status $RED "âŒ PUSH BLOCKED: Test suite failed!"
    print_status $YELLOW "   Run 'npm run test:production-ready' to see details"
    exit 1
fi

print_status $BLUE "ğŸ“Š Step 3: Coverage check..."

# Check test coverage
if npm run test:coverage > /dev/null 2>&1; then
    if [ -f "coverage/coverage-summary.json" ]; then
        coverage=$(node -e "const c = require('./coverage/coverage-summary.json'); console.log(c.total.lines.pct)")
        if [ "$(echo "$coverage >= 85" | bc -l)" -eq 1 ]; then
            print_status $GREEN "âœ… Test coverage: ${coverage}% (â‰¥85% required)"
        else
            print_status $RED "âŒ PUSH BLOCKED: Test coverage ${coverage}% below 85% threshold"
            exit 1
        fi
    else
        print_status $YELLOW "âš ï¸ Coverage report not found"
    fi
else
    print_status $YELLOW "âš ï¸ Coverage check failed"
fi

print_status $BLUE "ğŸ”’ Step 4: Security audit..."

# Security audit
if npm audit --audit-level=high > /dev/null 2>&1; then
    print_status $GREEN "âœ… No high-severity vulnerabilities"
else
    print_status $YELLOW "âš ï¸ High-severity vulnerabilities detected"
    print_status $YELLOW "   Run 'npm audit' to review and fix"
    # Don't block for audit failures (warn only)
fi

print_status $BLUE "ğŸ“± Step 5: Mobile configuration check..."

# Check Expo configuration
if command_exists expo; then
    if npx expo-doctor > /dev/null 2>&1; then
        print_status $GREEN "âœ… Expo configuration valid"
    else
        print_status $YELLOW "âš ï¸ Expo configuration issues detected"
        print_status $YELLOW "   Run 'npx expo-doctor' to review"
    fi
fi

print_status $BLUE "ğŸ” Step 6: Environment validation..."

# Check for required environment files
if [ ! -f ".env.example" ]; then
    print_status $YELLOW "âš ï¸ .env.example not found"
fi

if [ ! -f ".env.production.example" ]; then
    print_status $YELLOW "âš ï¸ .env.production.example not found"
fi

# Validate no production secrets in example files
if grep -q "sk_live\|pk_live\|rk_live" .env*.example 2>/dev/null; then
    print_status $RED "âŒ PUSH BLOCKED: Production secrets found in example files!"
    exit 1
fi

print_status $GREEN "ğŸ‰ All pre-push checks passed!"
print_status $BLUE "ğŸš€ Push allowed to proceed"

exit 0