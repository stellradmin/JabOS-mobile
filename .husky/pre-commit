#!/usr/bin/env sh
# =================================================================
# STELLR PRE-COMMIT HOOK
# =================================================================
# Runs security and quality checks before allowing commits
# Prevents commits with secrets, lint errors, or test failures

. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ”’ Running Stellr pre-commit security and quality checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}$message${NC}"
}

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

print_status $BLUE "ğŸ” Step 1: Secret scanning..."

# Check for gitleaks
if command_exists gitleaks; then
    # Run gitleaks on staged files only
    if ! gitleaks protect -v -c .gitleaks.toml --staged; then
        print_status $RED "âŒ COMMIT BLOCKED: Secrets detected in staged files!"
        print_status $RED "   Please remove all secrets before committing."
        print_status $YELLOW "   ğŸ’¡ Tip: Use EAS secrets for sensitive configuration"
        exit 1
    else
        print_status $GREEN "âœ… No secrets detected"
    fi
else
    print_status $YELLOW "âš ï¸ Gitleaks not found. Install with: brew install gitleaks"
fi

print_status $BLUE "ğŸ§¹ Step 2: Linting..."

# Run ESLint
if npm run lint > /dev/null 2>&1; then
    print_status $GREEN "âœ… Linting passed"
else
    print_status $RED "âŒ COMMIT BLOCKED: Linting errors detected!"
    print_status $YELLOW "   Run 'npm run lint' to see and fix issues"
    exit 1
fi

print_status $BLUE "ğŸ” Step 3: Type checking..."

# Run TypeScript check
if npm run type-check > /dev/null 2>&1; then
    print_status $GREEN "âœ… Type checking passed"
else
    print_status $RED "âŒ COMMIT BLOCKED: Type errors detected!"
    print_status $YELLOW "   Run 'npm run type-check' to see and fix issues"
    exit 1
fi

print_status $BLUE "ğŸ§ª Step 4: Quick tests..."

# Run quick tests (skip slow integration tests)
if npm test -- --passWithNoTests --bail --findRelatedTests $(git diff --cached --name-only --diff-filter=ACMRTUXB | grep -E '\.(js|jsx|ts|tsx)$' | tr '\n' ' ') > /dev/null 2>&1; then
    print_status $GREEN "âœ… Quick tests passed"
else
    print_status $YELLOW "âš ï¸ Some tests failed. Consider running full test suite."
    print_status $YELLOW "   Run 'npm test' to see detailed results"
    # Don't block commit for test failures in pre-commit (allow but warn)
fi

print_status $BLUE "ğŸ”’ Step 5: Security validation..."

# Check for common security anti-patterns in staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACMRTUXB | grep -E '\.(js|jsx|ts|tsx)$')

if [ -n "$staged_files" ]; then
    # Check for potential hardcoded secrets
    if echo "$staged_files" | xargs grep -l "sk_\|pk_live\|rk_live\|whsec_\|eyJ.*\.eyJ" 2>/dev/null; then
        print_status $RED "âŒ COMMIT BLOCKED: Potential API keys found in staged files!"
        print_status $YELLOW "   Please remove hardcoded secrets and use environment variables"
        exit 1
    fi
    
    # Check for console.log in production files (warn only)
    if echo "$staged_files" | xargs grep -l "console\.log\|console\.warn\|console\.error" 2>/dev/null; then
        print_status $YELLOW "âš ï¸ Console statements found. Consider removing for production."
    fi
    
    # Check for TODO/FIXME comments
    todo_count=$(echo "$staged_files" | xargs grep -c "TODO\|FIXME\|XXX" 2>/dev/null | awk -F: '{sum += $2} END {print sum}')
    if [ "$todo_count" -gt 0 ]; then
        print_status $YELLOW "âš ï¸ Found $todo_count TODO/FIXME comments in staged files"
    fi
fi

print_status $GREEN "ğŸ‰ All pre-commit checks passed!"
print_status $BLUE "ğŸ“ Commit allowed to proceed"

exit 0